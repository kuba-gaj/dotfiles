#!/usr/bin/env bash
# Usage: rofi -show clipboard -config ~/.config/rofi/config-clipboard.rasi
# TODO: hide id column

print_lines() {
	tmp_dir="/tmp/cliphist"
	rm -rf "$tmp_dir"

	mkdir -p "$tmp_dir"

	read -r -d '' prog <<EOF
/^[0-9]+\s<meta http-equiv=/ { next }
match(\$0, /^([0-9]+)\s(\[\[\s)?binary.*(jpg|jpeg|png|bmp)/, grp) {
    system("echo " grp[1] "\\\\\t | cliphist decode >$tmp_dir/"grp[1]"."grp[3])
    print \$0"\0icon\x1f$tmp_dir/"grp[1]"."grp[3]
    next
}
1
EOF
	cliphist list | gawk "$prog"
}

while true; do
	result=$(
		rofi -i -dmenu \
			-p "ðŸ“‹ Clipboard " \
			-display-columns 2 \
			-config ~/.config/rofi/config-clipboard.rasi < <(print_lines)
	)
	# print lines on start
	case "$?" in
	# canceled
	1) exit ;;
	# handle select line
	# normal selection
	0)
		cliphist decode <<<"$result" | wl-copy # && wtype -M ctrl -P v -m ctrl
		title=$(hyprctl -j activewindow | jq -r '.initialTitle')
		if [[ "$title" = "kitty" ]]; then
			wtype -M shift -M ctrl -P v -m ctrl
		else
			wtype -M ctrl -P v -m ctrl
		fi
		exit
		;;
	# kb-custom-1 (Ctrl-Delete)
	10) cliphist delete <<<"$result" ;;
	# kb-custom-2 (Alt-Delete)
	11)
		cliphist wipe
		exit
		;;
	esac
done
